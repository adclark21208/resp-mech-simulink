\section{Introduzione}

% \noindent
\textcolor{blue}{
	\lipsum[1-2]
}

\section{Background}


SCRIVI QUALCOSA

\subsection{Analogia circuitale}

\begin{figure*}[t!]
	\begin{subfigure}{0.5\linewidth}
		\centering
		\small{
			\def\svgwidth{\linewidth}
			\input{circuit.pdf_tex}}
		\caption{}
		\label{fig:modello}
	\end{subfigure}\hfill
	\begin{subfigure}{0.5\linewidth}
		\centering
		\small{
			\def\svgwidth{0.7\linewidth}
			\input{lung.pdf_tex}}
		\caption{}
	\end{subfigure}\hfill
	\caption{Analogia circuitale della meccanica respiratoria \cite{khoo_physiological_2018} (a); Rappresentazione schematica della divisione del circuito polmonare in due contributi resistivi (vie aeree superiori e inferiori) e in due contributi capacitivi (compliance del polmone e della parete toracica), raffigurate anche la pressione alveolare e pleurica.}
\end{figure*}

Il circuito polmonare può essere analizzando facendo un'analogia con i circuiti elettrici.

In particolare è possibile fare un parallelismo tra il flusso d'aria e la corrente elettrica (flusso di cariche) vedendo e la pressione come la presenza di un potenziale elettrico.
Si rivede allora la resistenza meccanica come il rapporto tra l'incremento di pressione rispetto il flusso, analoga alla resisitenza elettrica. Similmente la compliance non è altro che il rapporto tra l'aumento di volume e l'aumento di pressione, in analogia elettrica è un condensatore.

Il sistema in \cref{fig:modello} è un modello di meccanica respiratoria che trascura la presenza di contributi inerziali (non ci induttanze) e considera la presenza di due compartimenti. Sono separate le vie aeree superiori, con il loro contributo resistivo $R_C$ dalle vie aeree inferiori $R_P$. I due compartimenti sono in serie tra loro ed in serie ai serbatoi d'aria, ovvero le capacità rappresentanti il contributo di compliance della parete $C_W$ e del polmone $C_L$. 
Tali contributi sono in serie proprio perchè il volume d'aria passante è lo stesso. 

A questo si aggiunge anche la capacità di shunt $C_S$ che tiene conto di diversi contributi quali lo spazio morto anatomico, la deformabilità delle vie aeree e la comprimibilità dell'aria. Normalmente questo volume è molto piccolo in condizioni respiratorie normali (in assenza di patologie) e a basse frequenze respiratorie.

Si identificano allora anche le pressioni nei nodi. La pressione alle vie aeree $P_{aw}$, la pressione pleurica $P_{pl}$ e la pressione alveolare $P_A$. Chiaramente l'ingresso del sistema, dato dalla bocca e dalle cavità nasali, è rappresentato dalla pressione all'apertura delle vie aeree $P_{aO}$. 



\subsection{Risposta del sistema}

Il circuito in \cref{fig:modello} può essere descritto dalle seguenti equazioni:

\begin{equation}
	\footnotesize{
	\left\{\begin{array}{l}
		P_{a O}=Q R_{C}+\frac{1}{C_{S}} \int\left(Q-Q_{A}\right) \\
		\frac{1}{C_{s}} \int\left(Q-Q_{A}\right)=Q_{A} R_{P}+\left(\frac{1}{C_{L}}+\frac{1}{C_{W}}\right) \int Q_{A}
	\end{array}\right.}
\label{eq:modello}
\end{equation}

Si ottiene allora la funzione di trasferimento del sistema:

\begin{equation}
		\footnotesize{
\begin{aligned}
	H(s)&=\frac{Q(s)}{P_{a O}(s)}\\
	&=\frac{s^{2}+s \frac{1}{R_{P}}\left(\frac{1}{C_{S}}+\frac{1}{C_{e q}}\right)}{s^{2}\left(R_{C}\right)+s\left(\frac{R_{C}+R_{P}+\frac{R_{C} C_{S}}{C_{e q}}}{C_{S} R_{P}}\right)+\frac{1}{C_{e q} C_{S} R_{P}}}
\end{aligned}}
\label{eq:fdt}
\end{equation}

Dove si esprime la serie delle capacità come ${1\over C_{eq}}={1\over C_{L}}+{1\over C_{W}}$. 


\begin{figure*}[t!]
	\centering
	\includegraphics[width=\linewidth]{simulink_base.pdf}
	\caption{Modello del sistema in Simulink diviso in due blocchi principali, uno rappresentante il ventilatore polmonare e l'altro il sistema polmonare, a cui vengono aggiunti un blocco per il salvataggio dei dati e alcune funzioni di visualizzazione.}
	\label{fig:generale}
\end{figure*}

\subsection{Proprietà del sistema}


Chiaramente la soluzione di tale problema richiede la conoscenza della meccanica polmonare propria del paziente. Si assume che il paziente abbia una meccanica polmonare normale.

I coefficienti numerici vengono selezionati da \citeauthor{khoo_physiological_2018} \cite{khoo_physiological_2018}, sono riportati in \cref{tab:coefficienti}.


\begin{table}[h!]
	\centering
	\begin{tabular}{|c|c|c|}
		\hline
		Parametro & Valore & Unità \\ \hline
		$R_C$ & 1 & cm H\textsubscript{2}O s / L \\ \hline
		$R_P$ & 0.5 & cm H\textsubscript{2}O s / L \\ \hline
		$C_L$ & 0.2 & L / cm  H\textsubscript{2}O \\ \hline
		$C_W$ & 0.2 & L / cm  H\textsubscript{2}O \\ \hline
		$C_S$ & 0.005 & L / cm  H\textsubscript{2}O \\ \hline
	\end{tabular}
\caption{Coefficienti numerici per il sistema \cite{khoo_physiological_2018}}
\label{tab:coefficienti}
\end{table}

\subsection{Modellazione del sistema}

La risoluzione del sistema richiede la risoluzione di una ODE e l'approccio, quando le equazioni diventano complesse, è quello di trasferire il modello in un calcolatore. Il classico approccio è di tipo numerico, mediante l'utilizzo di un codice numerico di risoluzioni.

Esiste tuttavia la possibilità di utilizzare Simulink. 

\subsection{Simulink}


Simulink \cite{simulink} è un software sviluppato da MathWorks che fornisce un approccio grafico basato su un ambiente che permette all'utente di convertire il problema in una rete di blocchi di funzioni matematica. 

Inoltre, tale ambiente permette l'integrazione con l'ambiente di Matlab e le relative funzioni di programmazione. 

Un primo approccio sintetico potrebbe essere quello di diagrammare un sistema ingresso-uscita per il tramite della funzione di trasferimento in \cref{eq:fdt}. Tale modello risulterebbe però troppo sintetico e non permetterebbe l'accesso ad alcune variabili esterne, come i singoli flussi.

Si sceglie allora di modellare il sistema completo in \cref{eq:modello}. Tale sistema viene modellato nel blocco \texttt{lungs}. Vengono poi aggiunti anche un sotto sistema per simulare un ventilatore polmonare, ovvero l'ingresso come $P_{aO}$, e un blocco per visualizzare e salvare i dati.

Uno schema generale di alto livello è presente in \cref{fig:generale}


\subsubsection{Sotto sistema del ventilatore}


\begin{figure*}[t!]
	\centering
	\begin{subfigure}{0.4\linewidth}
		\centering
		\includegraphics[width=\linewidth]{simulink_ventilator.pdf}
		\caption{}
	\end{subfigure}\hfill
	\begin{subfigure}{0.6\linewidth}
		\centering
		\includegraphics[angle=90,width=0.95\linewidth]{simulink_ventilator_GUI}
		\caption{}
		\label{fig:mask}
	\end{subfigure}\hfill
	\caption{Sistema di input rappresentante il ventilatore: schema a blocchi Simulink dove il segnale di ingresso ($P_{aO}$) viene generato tramite una funzione (\text{fcn}) Matlab (a); GUI tramite la quale è possibile selezionare la frequenza respiratoria e selezionare la forma d'onda.}
\end{figure*}


Nel sotto sistema del ventilatore l'obiettivo è di fornire una $P_{aO}$ con una forma d'onda precisa. Vengono fornite diverse forme d'onda e la frequenza stessa, in atti respiratorio per minuto, può essere variata.

Per fare questo si utilizza un blocco \texttt{funzione Matlab} mediante il quale si può definire un codice Matlab contente la forma d'onda della pressione al variare del tempo di input. Maggiori informazioni sono riportare in appendice. 

Tale blocco richiede anche due variabili ausiliare tramite le quali è possibile scegliere la frequenza respiratoria e il tipo di forma d'onda direttamente dall'interfaccia grafica della maschera del blocco (\cref{fig:mask}). Tramite la maschera di blocco viene anche settata una funzione di callback che permette di aggiornare il nome del file di output, non appena vengono cambiati i parametri, con una struttura del tipo:
\begin{equation*}
	\text{"forma d'onda } + \text{ frequenza } + \text{ .mat"}
\end{equation*}


\subsubsection{Sotto sistema del polmone}


\begin{figure*}[t!]
	\centering
	\includegraphics[width=\linewidth]{simulink_lung.pdf}
	\caption{Modello del blocco in Simulink rappresentante il circuito polmonare (in \cref{eq:modello}, \cref{fig:modello})}
	\label{fig:simulinkLung}
\end{figure*}

Le equazioni descrittive del sistema (\cref{eq:modello}) e i relativi segmenti circuitali possono essere rappresentati direttamente nel modello Simulink in \cref{fig:simulinkLung}. 

Tramite la modellazione in Simulink è possibile sommare i contributi di segnale (rappresentanti segmenti del circuito o, equivalentemente, membri dell'equazione), moltiplicare per un costante applicando un guadagno al segnale, derivare e integrare. 
Chiaramente, per passare dal flusso al volume è sufficiente integrare nel tempo. 

Sono presenti anche 3 blocchi di tipo \texttt{scope} per visualizzare le forme d'onda direttamente all'interno della simulazione, il blocco di ingresso (prende il segnale $P_{aO}$ direttamente dal ventilatore) e i 3 blocchi di output utilizzare per salvare i dati. 


\section{Risultati}

\subsection{Ventilazioni ideali}

Un approccio semplice, per analizzare la meccanica polmonare, è quello di ventilare con una forma d'onda ideale. Si utilizza come prima analisi una forma sinusoidale di ampiezza di 2.5 cm H\textsubscript{2}O (ampiezza picco-picco di 5 cm H\textsubscript{2}O) con una frequenza di 15 respiri al minuto \cite{khoo_physiological_2018}, simile alla respirazione a riposo.

Dai grafici in \cref{fig:sine_wave_15} è possibile vedere come il volume segue un andamento simile, seppur leggermente sfasato. Questo è indice che, a bassa frequenza, l'andamento è dominato dal contributo di compliance (dove c'è proporzionalità con l'integrale del flusso). L'ampiezza di picco del volume raggiunge 0.5 L e il flusso circa 0.7 L/s. L'andamento del flusso invece è significativamente sfasato rispetto il contributo di pressione in ingresso. 

\begin{figure*}[t!]
\begin{subfigure}{0.5\linewidth}
	\centering
	\includegraphics[width=0.95\linewidth]{../model/data_log/data_sine_wave_freq_15.pdf}
	\caption{}
\end{subfigure}\hfill
\begin{subfigure}{0.5\linewidth}
	\centering
	\includegraphics[width=0.95\linewidth]{../model/data_log/data_sine_wave_freq_15_zoom.pdf}
	\caption{}
\end{subfigure}
\caption{Confronto tra la pressione in ingresso con forma d'onda sinusoidale ideale con l'andamento del flusso e del volume (a); ingrandimento sull'andamento di flusso e volume (b). Si può osservare come volume e sfasamento presentano uno sfasamento di 90°. Inoltre, ne flusso ne volume sono in fase con l'andamento della $P_{aO}$. }
\label{fig:sine_wave_15}
	\centering
\includegraphics[width=0.95\linewidth]{../model/data_log/data_sine_wave_freq_45_zoom.pdf}
\caption{Andamento di flusso, volume e $P_{aO}$. L'ampiezza della $P_{aO}$ è scalata di un fattore $1/2$. Per la curva del flusso si osserva una riduzione delle sfasamento e un aumento dell'ampiezza di picco.Il volume tende a ridursi (rispetto al caso 15 respiri/min) simbolo di un comportamento più rigido del polmone.}
\label{fig:sine_wave_45}
\end{figure*}

Aumentando la frequenza, triplicando il numero di respiri al minuto (\cref{fig:sine_wave_45}), il polmone appare più rigido e infatti l'ampiezza del volume tende a ridursi nonostante aumenti il flusso. L'ampiezza di picco del volume passa da 0.5 L a 0.4 L sebbene il flusso sia passato da 0.7 L/s a quasi 2 L/s. Questo rappresenta come nonostante il ricambio d'aria sia maggiore il polmone per aumentare la frequenza respiratoria è costretto ad espandersi meno limitando l'introito complessivo di aria.   

Inoltre, l'andamento del volume tende a sfasarsi maggiormente rispetto l'andamento della pressione mentre il flusso sembra essere più in fase, simbolo di un maggior contributo di tipo resistivo (proporzionalità diretta pressione-flusso).

Quindi, mentre a bassa frequenza (riposo) il contributo è maggiormente legato alla compliance, ad alta frequenza il comportamento resistivo sembra essere maggiormente presente.
\\

Una forma d'onda alternativa è l'onda quadra. Si può impostare una forma d'onda con ampiezza di picco equivalente alla precedente. Si osserva una risposta del sistema differente.

\begin{figure*}[t!]
	\begin{subfigure}{0.5\linewidth}
		\centering
		\includegraphics[width=0.95\linewidth]{../model/data_log/data_square_wave_freq_18.pdf}
		\caption{}
	\end{subfigure}\hfill
	\begin{subfigure}{0.5\linewidth}
		\centering
		\includegraphics[width=0.95\linewidth]{../model/data_log/PV_sine_vs_square.pdf}
		\caption{}
	\end{subfigure}
	\caption{Andamento di flusso e volume rispetto l'ingresso di $P_{aO}$ come onda quadra con una frequenza di 18 respiri/min (a); grafico pressione-volume per ingresso sinusoidale e ad onda quadra)}
	\label{fig:square_wave_45}
\end{figure*}

Si osserva come il flusso torna rapidamente a zero e inizia una fase di plateau del volume. Successivamente inizia la fase inspiratoria dove il flusso presenta una curva simmetrica ma negativa con un picco della stessa ampiezza e il volume esce gradualmente. 

Inoltre, variando la frequenza il comportamento della curve di flusso e di volume non cambia ma si riduce la fase di plateau del volume. 
\\

Chiaramente tale forme d'onda sono modelli analitici che nell'applicazione reale presenterebbero diversi problemi. Nella pratica clinica non si utilizzano mai pressioni negative ma si mantiene sempre un gradiente di pressione positivo per cui tali curve sono da escludere per casi applicativi realistici. Si osservi anche come la stessa presenza di un volume negativo, nella forma d'onda sinusoidale, non è desiderabile per un ventilatore il cui scopo è aiutare il paziente a respirare riducendo il lavoro respiratorio del polmone o sostituendolo completamente.

\subsection{Ventilazione a controllo di pressione}

Le analisi precedente sono utili per capire il modello matematico e per avere un'idea di base sulla meccanica respiratoria. Tuttavia, in clinica, l'approccio alla ventilazione è leggermente differente. 

Al fine di realizzare un simulatore digitale di un ventilatore polmonare si considera una forma d'onda tipicamente diffusa in clinica per la ventilazione a controllo di pressione \cite{al-naggar_modelling_2015}. 

La ventilazione polmonare assistita si divide in due macro categorie: controllo di volume e controllo di pressione. Sono presenti diversi vantaggi/svantaggi in entrambe e la scelta si basa su diverse considerazioni paziente specifiche. Nella ventilazione a controllo di pressione (VCP) si imposta un target specifico, la pressione alle vie aeree $P_{aO}$ e il ventilatore deve mantenerla. A seconda del macchinario utilizzato possono essere variati alcuni parametri quali la percentuale di ossigeno, il volume tidale o la ventilazione per minuto, la frequenza respiratoria, il tempo inspiratorio, il flusso o settare dei valori limite per la pressione \cite{grossbach_overview_2011}.

Una curva generica, tipica della VCP, è costituita da un'onda quadra con un offset positivo che prende il nome di PEEP, positive end-expiratory pressure. Il periodo $T=\frac{1}{\text{freq. respiratoria}}$ è composto da un tempo di inspirazione e un tempo inspirazione. Facoltativamente può essere presente un certo tempo di salita, espresso in funzione del tempo di inspirazione \cite{al-naggar_modelling_2015}. 

Questo può essere espresso come una curva lineare a tratti (\cref{fig:PCV}) di periodo $T=T_{insp}+T_{esp}$:

\begin{equation}
	\small{
	P(t)=\left\{\begin{array}{c}
		P_{aO} \cdot \frac{t}{\tau}+\mathrm{PEEP} \\
		P_{aO}+\mathrm{PEEP} \\
		\mathrm{PEEP}
	\end{array}\right.\quad \begin{aligned}
		&0 \leq t < \tau \\
		&\tau \leq t < T_{insp} \\
		&T_{insp} \leq t 
	\end{aligned}}
\end{equation}

 \begin{figure*}[t!]
	\begin{subfigure}[b]{0.5\linewidth}
		\centering
		\footnotesize{
			\def\svgwidth{\linewidth}
			\input{PCV_VCV.pdf_tex}}
		\caption{}
	\end{subfigure}\hfill
	\begin{subfigure}[b]{0.5\linewidth}
		\centering
		\footnotesize{
			\def\svgwidth{\linewidth}
			\input{PCV.pdf_tex}}
		\caption{}
		\label{fig:PCV}
	\end{subfigure}
	\caption{Differenza tra le curve ottenute in ventilazione a controllo di pressione (VCV) e a controllo di pressione (PCV) (a); generica forma d'onda per la ventilazione a controllo di pressione (b)}
	\label{fig:clinical}
\end{figure*}

La PEEP generalmente si mantiene tra $5\div 10$ cmH\textsubscript{2}O mantenendo il volume nel range di $4\div 6$ ml/kg di peso corporeo. La $P_{aO}$ viene mantenuta sotto i 35 cm H\textsubscript{2}O \cite{ball_modes_2015}.

A tal proposito viene anche modificata l'interfaccia grafica (\cref{fig:mask}) in moto tale da permette la selezione di una forma d'onda di tipo onda quadra con un rise time e un offset di pressione, lasciando all'utente la possibilità di scegliere frequenza, tempo di inspirazione (in funzione del periodo), rise time (in funzione del tempo di inspirazione), $P_{aO}$ e $\mathrm{PEEP}$. 
 


Una volta impostato tale simulatore permette di calibrare la ventilazione e di addestrarsi nell'utilizzo di un ventilatore reale andando a vedere come i diversi parametri di ventilazione influenzano la meccanica respiratoria e soprattutto come modificare la ventilazione in base alla risposta del paziente.
\\

Nelle sezioni successive vengono fissati i parametri di ventilazione ad una frequenza di 18 respiri/min, un tempo di inspirazione del 40\% e un rise time del 20\%, con una $\mathrm{PEEP}$ di 5 cm H\textsubscript{2}O e una $P_{aO}=25$  cm H\textsubscript{2}O, e si analizza come varia la ventilazione in funzione della variazione dei parametri del paziente. 

 \begin{figure*}[t!]
	\begin{subfigure}{0.5\linewidth}
		\centering
\includegraphics[width=0.95\linewidth]{../model/data_log/data_square_wave_rise_15_Tinsp_40_PEEP_5_Paw_25_freq_18}
		\caption{}
	\end{subfigure}\hfill
	\begin{subfigure}{0.5\linewidth}
		\centering
\includegraphics[width=0.95\linewidth]{../model/data_log/PV_rise_time.pdf}
		\caption{}
	\end{subfigure}
	\caption{PCV con $T_{insp}=0.4*T$, $f=$18 respiri/min, $\tau=0.15*T_{insp}$, $\mathrm{PEEP}=5$ cm H\textsubscript{2}O e $P_{aO}=25$ cm H\textsubscript{2}O (a); diagramma PV di confronto con differenti tempi di salita, si osserva come varia il primo ramo di salita del volume, riducendo il rise time l'incremento di volume diventa sempre più brusco ma il volume massimo raggiunto è sempre lo stesso}
	\label{fig:rise_time}
\end{figure*}

\subsection{Resistenza delle vie aeree}

\textcolor{blue}{
	\lipsum[1-4]
}

\subsection{Compliance polmonare}
\section{Conclusioni}

\textcolor{blue}{
	\lipsum[1-2]
}
%\pagebreak
\section*{Disponibilità dei dati}

Il materiale è disponibile alla repository online del progetto: \url{https://github.com/mastroalex/resp-mech-simulink}

\subsection*{Codice}

\raggedbottom

\pagebreak
\printbibliography[title=Riferimenti]
%\section*{References}


\clearpage
\section*{Appendice}

\subsection*{Codice per la generazione della pressione di ingresso}
